@page "/fizzbuzz"
@using System.Numerics
@rendermode InteractiveServer

<PageTitle>FizzBuzz</PageTitle>

<h3>FizzBuzz Challenge</h3>

#region Style and Layout
<style>
    .main-layout {
        display: flex;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background-color: #f8f9fa;
        height: 525px;
    }

    .viewport-container {
        flex-grow: 1;
        user-select: none;
        overflow: hidden;
    }

    .scrollbar-track {
        width: 16px;
        background: #eee;
        border-left: 1px solid #dee2e6;
        position: relative;
        cursor: pointer;
    }

    .scrollbar-thumb {
        position: absolute;
        width: 14px;
        left: 1px;
        background: #888;
        border-radius: 7px;
        cursor: grab;
        min-height: 20px;
        transition: background-color 0.15s ease;
    }

    .scrollbar-thumb:hover {
        background: #666;
    }

    .scrollbar-thumb:active {
        cursor: grabbing;
        background: #555;
    }

    .result-row {
        padding: 4px 15px;
        border-bottom: 1px solid #ececec;
        font-family: monospace;
        display: flex;
        justify-content: space-between;
        height: 35px;
    }

    .value-label { font-weight: bold; }
</style>

<div class="row my-3">
    <div class="col-md-2">
        <label>Check numbers up to:</label>
        <input type="number" class="form-control" @bind-value="LimitInput" />
    </div>

    <div class="col-md-2">
        <label>Divisor 1: </label>
        <input type="number" class="form-control" @bind="Divisor1Input" />
    </div>
    <div class="col-md-2">
        <label>Phrase 1: </label>
        <input type="text" class="form-control" @bind="Phrase1" />
    </div>

    <div class="col-md-2">
        <label>Divisor 2: </label>
        <input type="number" class="form-control" @bind="Divisor2Input" />
    </div>
    <div class="col-md-2">
        <label>Phrase 2: </label>
        <input type="text" class="form-control" @bind="Phrase2" />
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary btn-align-end" @onclick="RunLoop">Run</button>
    </div>
</div>
#endregion

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
@if (!string.IsNullOrEmpty(runMessage))
{
    <div class="alert alert-success">@runMessage</div>
}

@if (showResults)
{
    <div class="main-layout">
        <div class="viewport-container" @onwheel="HandleWheel">
            @for (BigInteger i = CurrentStart; i < CurrentStart + PageSize && i <= Limit; i++)
            {
                <div class="result-row">
                    <span class="value-label">@GetItemValue(i)</span>
                </div>
            }
        </div>
        <div class="scrollbar-track" @onclick="HandleTrackClick">
            <div class="scrollbar-thumb" 
                 style="top: @(GetThumbTop())px; height: @(GetThumbHeight())px;"
                 @onclick:stopPropagation="true">
            </div>
        </div>
    </div>
}

@code {
    // Layout Constants
    private const int PageSize = 15;
    private const int TrackHeight = 525;
    private const int MinThumbHeight = 10;

    // Input Bindings
    private string LimitInput { get; set; } = "30";
    private string Divisor1Input { get; set; } = "3";
    private string Divisor2Input { get; set; } = "5";
    private string Phrase1 { get; set; } = "fizz";
    private string Phrase2 { get; set; } = "buzz";

    // Parsed Values
    private BigInteger Limit;
    private BigInteger Divisor1;
    private BigInteger Divisor2;

    // UI State
    private bool showResults = false;
    private string? errorMessage;
    private string? runMessage;

    // Viewport State
    private BigInteger CurrentStart { get; set; } = 1;

    private BigInteger MaxStart => Limit > PageSize ? Limit - PageSize + 1 : 1;

    private void HandleWheel(WheelEventArgs e)
    {
        if (e.DeltaY > 0 && CurrentStart < MaxStart)
            CurrentStart++;
        else if (e.DeltaY < 0 && CurrentStart > 1)
            CurrentStart--;
    }

    private void HandleTrackClick(MouseEventArgs e)
    {
        if (Limit <= PageSize) return;

        double thumbHeight = GetThumbHeight();
        double availableSpace = TrackHeight - thumbHeight;
        if (availableSpace <= 0) return;

        double targetThumbTop = Math.Clamp(e.OffsetY - (thumbHeight / 2), 0, availableSpace);

        double ratio = targetThumbTop / availableSpace;
        BigInteger newStart = 1 + (BigInteger)(ratio * (double)(Limit - PageSize));

        CurrentStart = BigInteger.Clamp(newStart, 1, MaxStart);
    }

    private double GetThumbHeight()
    {
        if (Limit <= 0) return TrackHeight;

        double ratio = Math.Min((double)PageSize / (double)Limit, 1.0);
        return Math.Max(ratio * TrackHeight, MinThumbHeight);
    }

    private double GetThumbTop()
    {
        if (Limit <= PageSize) return 0;

        double availableSpace = TrackHeight - GetThumbHeight();
        double ratio = (double)(CurrentStart - 1) / (double)(Limit - PageSize);

        return ratio * availableSpace;
    }

    private string GetItemValue(BigInteger i)
    {
        if (i % Divisor1 == 0 && i % Divisor2 == 0)
            return Phrase1 + Phrase2;
        else if (i % Divisor1 == 0)
            return Phrase1;
        else if (i % Divisor2 == 0)
            return Phrase2;
        else
            return i.ToString("N0");
    }

    private void RunLoop()
    {
        errorMessage = null;
        runMessage = null;
        showResults = false;

        if (string.IsNullOrWhiteSpace(Phrase1)) Phrase1 = "fizz";
        if (string.IsNullOrWhiteSpace(Phrase2)) Phrase2 = "buzz";

        if (!BigInteger.TryParse(LimitInput, out Limit) || Limit <= 0)
        {
            errorMessage = "Please enter a valid positive integer for Limit value [Limit > 0].";
            return;
        }

        if (!BigInteger.TryParse(Divisor1Input, out Divisor1) || Divisor1 <= 0)
        {
            errorMessage = "Please enter a valid positive integer for Divisor 1 value [Divisor > 0].";
            return;
        }

        if (!BigInteger.TryParse(Divisor2Input, out Divisor2) || Divisor2 <= 0)
        {
            errorMessage = "Please enter a valid positive integer for Divisor 2 value [Divisor > 0].";
            return;
        }

        runMessage = $"Running FizzBuzz up to {Limit:N0} with divisors {Divisor1:N0} and {Divisor2:N0}.";
        CurrentStart = 1;
        showResults = true;
    }
}
